# üìö DOCUMENTACI√ìN COMPLETA - EST√âTICA INTEGRAL
**Sistema de Gesti√≥n de Turnos**  
**Versi√≥n:** 2.0.0 | **Fecha:** Octubre 2025

---

## üìã √çNDICE

1. [Arquitectura T√©cnica](#arquitectura-t√©cnica)
2. [Configuraci√≥n y Deployment](#configuraci√≥n-y-deployment)
3. [Testing y Calidad](#testing-y-calidad)
4. [Bugs Corregidos](#bugs-corregidos)
5. [Mejoras Implementadas](#mejoras-implementadas)
6. [API Reference](#api-reference)
7. [Troubleshooting](#troubleshooting)

---

## üèóÔ∏è ARQUITECTURA T√âCNICA

### Stack Tecnol√≥gico

**Frontend:**
- Next.js 15.5 (App Router)
- TypeScript 5.x
- Tailwind CSS 3.4
- React 19
- Headless UI (modales y componentes)

**Backend:**
- Supabase (PostgreSQL + Auth)
- Next.js API Routes
- Nodemailer (emails)
- JWT (jose) para autenticaci√≥n

**Seguridad:**
- express-rate-limit (anti-spam)
- Google reCAPTCHA v3 (anti-bot)
- bcryptjs (hash de passwords)
- RLS (Row Level Security)

### Estructura de Carpetas

```
estetica.integral/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                    # Next.js App Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/              # Panel administrativo
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/     # Componentes admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/          # Login page
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx        # Dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx          # Layout ra√≠z
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx            # Home p√∫blica
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globals.css         # Estilos globales
‚îÇ   ‚îú‚îÄ‚îÄ components/             # Componentes compartidos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppointmentBooking.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RecaptchaProvider.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ServiceSelection.tsx
‚îÇ   ‚îî‚îÄ‚îÄ lib/                    # Utilidades
‚îÇ       ‚îú‚îÄ‚îÄ supabase.ts         # Cliente p√∫blico
‚îÇ       ‚îú‚îÄ‚îÄ supabase-admin.ts   # Cliente admin
‚îÇ       ‚îú‚îÄ‚îÄ date-utils.ts       # Manejo de fechas
‚îÇ       ‚îú‚îÄ‚îÄ email.ts            # Sistema de emails
‚îÇ       ‚îú‚îÄ‚îÄ recaptcha.ts        # Verificaci√≥n CAPTCHA
‚îÇ       ‚îú‚îÄ‚îÄ rate-limit.ts       # Rate limiting
‚îÇ       ‚îú‚îÄ‚îÄ admin-auth.ts       # Autenticaci√≥n admin
‚îÇ       ‚îú‚îÄ‚îÄ logger.ts           # Logger condicional
‚îÇ       ‚îî‚îÄ‚îÄ pdf-generator.ts    # Generaci√≥n de PDFs
‚îú‚îÄ‚îÄ pages/api/                  # API Routes
‚îÇ   ‚îú‚îÄ‚îÄ appointments.ts         # API p√∫blica
‚îÇ   ‚îú‚îÄ‚îÄ admin/                  # APIs protegidas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appointments.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patients.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schedules.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ closures.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ announcements.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logout.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refresh-token.ts
‚îÇ   ‚îî‚îÄ‚îÄ cron/                   # Cron jobs
‚îÇ       ‚îî‚îÄ‚îÄ send-reminders.ts
‚îú‚îÄ‚îÄ database/                   # Scripts SQL
‚îÇ   ‚îî‚îÄ‚îÄ supabase-schema.sql
‚îú‚îÄ‚îÄ __tests__/                  # Tests automatizados
‚îÇ   ‚îú‚îÄ‚îÄ appointment-overlap.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ date-utils.test.ts
‚îú‚îÄ‚îÄ public/                     # Assets est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json           # PWA manifest
‚îÇ   ‚îî‚îÄ‚îÄ images/
‚îú‚îÄ‚îÄ middleware.ts               # Middleware de auth
‚îú‚îÄ‚îÄ next.config.js              # Configuraci√≥n Next.js + PWA
‚îú‚îÄ‚îÄ vercel.json                 # Cron jobs config
‚îî‚îÄ‚îÄ package.json                # Dependencias
```

---

## ‚öôÔ∏è CONFIGURACI√ìN Y DEPLOYMENT

### Paso 1: Clonar Repositorio

```bash
git clone https://github.com/cocomeza/estetica.integral.git
cd estetica.integral
npm install
```

### Paso 2: Configurar Variables de Entorno

Crear archivo `.env.local`:

```env
# ========================================
# B√ÅSICO (REQUERIDO)
# ========================================

NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=tu_anon_key
SUPABASE_SERVICE_ROLE_KEY=tu_service_role_key
JWT_SECRET=tu_secret_minimo_32_caracteres

# ========================================
# SEGURIDAD (RECOMENDADO)
# ========================================

# Google reCAPTCHA v3
# Obtener en: https://www.google.com/recaptcha/admin
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=tu_site_key
RECAPTCHA_SECRET_KEY=tu_secret_key

# ========================================
# EMAILS (OPCIONAL)
# ========================================

# Gmail SMTP
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu-email@gmail.com
SMTP_PASS=tu_app_password
SMTP_FROM_NAME=Est√©tica Integral
SMTP_FROM_EMAIL=noreply@esteticaintegral.com.ar

# Cron Job Secret
CRON_SECRET=tu_cron_secret
```

### Paso 3: Configurar Supabase

1. Crear proyecto en [Supabase](https://supabase.com)
2. Ir a SQL Editor
3. Ejecutar `database/supabase-schema.sql`
4. Copiar las credenciales a `.env.local`

### Paso 4: Deployment en Vercel

```bash
# 1. Push a GitHub (si no est√°)
git add -A
git commit -m "Initial deployment"
git push origin main

# 2. Importar en Vercel
# - Ir a vercel.com
# - Import repository
# - Configurar variables de entorno
# - Deploy

# 3. Configurar Cron Job
# - Agregar CRON_SECRET en Vercel
# - El archivo vercel.json ya est√° configurado
```

### Obtener Google reCAPTCHA

1. Ir a https://www.google.com/recaptcha/admin
2. Click en "+" para nuevo sitio
3. Tipo: **reCAPTCHA v3**
4. Dominios: `localhost` (dev) + `tu-dominio.vercel.app` (prod)
5. Copiar keys a `.env.local`

### Configurar Gmail SMTP

1. Ir a https://myaccount.google.com/security
2. Activar "2-Step Verification"
3. Ir a "App Passwords"
4. Generar password para "Mail"
5. Copiar a `SMTP_PASS` en `.env.local`

---

## üß™ TESTING Y CALIDAD

### Tests Automatizados

**Ejecutar tests:**
```bash
npm test                  # Todos los tests
npm test -- --watch       # Mode watch
npm test -- --coverage    # Con coverage
```

**Tests incluidos:**
- `appointment-overlap.test.ts` - 27 casos de overlap de horarios
- `date-utils.test.ts` - 15 casos de manejo de fechas

### Bugs Cr√≠ticos Corregidos

#### ‚úÖ Bug #1: Race Condition en Reservas
**Problema:** Dos usuarios pod√≠an reservar el mismo horario.  
**Soluci√≥n:** Constraint UNIQUE en BD + manejo de error 23505.

#### ‚úÖ Bug #3: Overlap de Horarios
**Problema:** No validaba superposici√≥n de servicios con duraci√≥n.  
**Soluci√≥n:** C√°lculo de intervalos ocupados considerando duraci√≥n completa.

```typescript
// Verificar que no haya overlap
if (
  (proposedStart >= occupied.start && proposedStart < occupied.end) ||
  (proposedEnd > occupied.start && proposedEnd <= occupied.end) ||
  (proposedStart <= occupied.start && proposedEnd >= occupied.end)
) {
  hasOverlap = true
}
```

#### ‚úÖ Bug #5: Reservas en Fechas Cerradas
**Problema:** Se pod√≠an crear citas en vacaciones/feriados.  
**Soluci√≥n:** Verificaci√≥n de tabla `closures` antes de crear/editar.

#### ‚úÖ Bug #6: Horario de Almuerzo
**Problema:** Horarios de almuerzo aparec√≠an como disponibles.  
**Soluci√≥n:** Exclusi√≥n de `lunch_start` a `lunch_end` en c√°lculos.

#### ‚úÖ Bug #8: Intervalos Fijos de 30 min
**Problema:** Siempre intervalos de 30 min sin importar duraci√≥n.  
**Soluci√≥n:** Intervalos din√°micos seg√∫n duraci√≥n del servicio.

#### ‚úÖ Bug #9: Servicios Permitidos por D√≠a
**Problema:** No validaba `allowed_services` de horarios.  
**Soluci√≥n:** Verificaci√≥n antes de mostrar horarios disponibles.

---

## üöÄ MEJORAS IMPLEMENTADAS

### üî¥ Seguridad (Prioridad Alta)

#### 1. Rate Limiting
- 3 reservas por hora por IP
- 5 intentos de login cada 15 min
- Middleware en endpoints cr√≠ticos

**Archivo:** `src/lib/rate-limit.ts`

#### 2. Google reCAPTCHA v3
- Verificaci√≥n invisible
- Score m√≠nimo 0.5
- Integrado en reservas

**Archivos:** `src/lib/recaptcha.ts`, `src/components/RecaptchaProvider.tsx`

#### 3. Notificaciones Email
- Confirmaci√≥n autom√°tica
- Recordatorio 24h antes
- Plantillas HTML profesionales

**Archivos:** `src/lib/email.ts`, `pages/api/cron/send-reminders.ts`

### üü° UX y Validaciones

#### 4. Validaci√≥n Mejorada
- Email: Regex estricta con TLD
- Tel√©fono: Formato argentino validado

#### 5. Vista de Calendario
- Calendario mensual personalizado
- Click en d√≠as para ver citas
- Toggle lista/calendario

**Archivo:** `src/app/admin/components/CalendarView.tsx`

#### 6. Cambios Sin Guardar
- Advertencia antes de salir
- Tracking de modificaciones

#### 7. Rotaci√≥n de Tokens
- Access token: 1 hora
- Refresh token: 7 d√≠as

**Archivo:** `pages/api/admin/refresh-token.ts`

### üü¢ Optimizaciones

#### 8. Dashboard Mejorado
- 12 m√©tricas (antes: 4)
- Top 5 servicios
- Tasa de ocupaci√≥n

#### 9. B√∫squeda Avanzada
- Busca en pacientes, servicios y especialistas
- Resultados combinados

#### 10. PWA
- Instalable en m√≥viles
- Funciona offline
- Service worker autom√°tico

**Archivos:** `next.config.js`, `public/manifest.json`

---

## üì° API REFERENCE

### Endpoints P√∫blicos

#### POST `/api/appointments`
Crear nueva reserva (con rate limiting y CAPTCHA).

**Request:**
```json
{
  "specialistId": "uuid",
  "serviceId": "uuid",
  "appointmentDate": "2025-10-25",
  "appointmentTime": "10:00",
  "duration": 45,
  "patientInfo": {
    "name": "Juan P√©rez",
    "email": "juan@email.com",
    "phone": "+54 11 1234-5678"
  },
  "recaptchaToken": "token_from_frontend"
}
```

**Response 201:**
```json
{
  "success": true,
  "appointment": {
    "id": "uuid",
    "appointment_date": "2025-10-25",
    "appointment_time": "10:00",
    ...
  }
}
```

**Errors:**
- `400` - Datos faltantes o inv√°lidos
- `429` - Rate limit excedido
- `500` - Error del servidor

---

### Endpoints Admin (Requieren autenticaci√≥n)

#### GET `/api/admin/appointments`
Obtener lista de citas con filtros.

**Query params:**
- `page` - N√∫mero de p√°gina (default: 1)
- `limit` - Items por p√°gina (default: 10)
- `search` - B√∫squeda en m√∫ltiples campos
- `status` - all | scheduled | completed | cancelled
- `specialistId` - Filtrar por especialista
- `startDate` - Fecha desde (YYYY-MM-DD)
- `endDate` - Fecha hasta (YYYY-MM-DD)

#### POST `/api/admin/appointments`
Crear cita desde admin.

#### PUT `/api/admin/appointments`
Actualizar cita existente.

#### DELETE `/api/admin/appointments`
Eliminar cita.

#### POST `/api/admin/login`
Login de administrador (con rate limiting).

#### POST `/api/admin/refresh-token`
Renovar access token usando refresh token.

#### GET `/api/admin/stats`
Obtener estad√≠sticas del dashboard.

---

### Cron Jobs

#### POST `/api/cron/send-reminders`
Env√≠a recordatorios 24h antes (ejecuta diariamente a las 10 AM).

**Headers requeridos:**
```
Authorization: Bearer {CRON_SECRET}
```

---

## üîí SEGURIDAD

### M√∫ltiples Capas de Protecci√≥n

**Capa 1: Frontend**
- Validaci√≥n de inputs
- reCAPTCHA invisible
- Formularios controlados
- Sanitizaci√≥n de datos

**Capa 2: API Routes**
- Rate limiting
- Verificaci√≥n de CAPTCHA
- Validaci√≥n de datos
- Middleware de autenticaci√≥n

**Capa 3: Backend (Supabase)**
- Row Level Security (RLS)
- Constraints UNIQUE
- Foreign keys
- Triggers de validaci√≥n

**Capa 4: Base de Datos**
- Constraint: `UNIQUE(specialist_id, appointment_date, appointment_time)`
- Check constraints en estados
- Validaci√≥n de fechas

### Autenticaci√≥n Admin

**Flujo de Login:**
1. POST `/api/admin/login` con email y password
2. Verificaci√≥n contra `admin_users` table
3. Genera access token (1h) + refresh token (7d)
4. Cookies httpOnly, secure, sameSite: strict

**Flujo de Refresh:**
1. Access token expira despu√©s de 1h
2. POST `/api/admin/refresh-token` con refresh token
3. Genera nuevo access token
4. Refresh token v√°lido por 7 d√≠as

### Rate Limiting

**Endpoints protegidos:**
- `/api/appointments` - 3 requests/hora
- `/api/admin/login` - 5 intentos/15min
- Otros endpoints - 100 requests/15min

**Bypass en desarrollo:**
```typescript
skip: (req) => process.env.NODE_ENV === 'development'
```

---

## üé® PALETA DE COLORES

```css
:root {
  --bone: #e5cfc2;      /* Fondo suave */
  --shark: #26272b;     /* Texto principal */
  --chicago: #605a57;   /* Texto secundario */
  --tapestry: #a6566c;  /* Primary/acento */
}
```

**Uso en Tailwind:**
```javascript
// tailwind.config.js
colors: {
  'bone': '#e5cfc2',
  'shark': '#26272b',
  'chicago': '#605a57',
  'tapestry': '#a6566c',
  'primary': '#a6566c',
  'secondary': '#605a57',
  'neutral': '#26272b',
  'light': '#e5cfc2',
}
```

---

## üìß SISTEMA DE EMAILS

### Configuraci√≥n SMTP

**Gmail:**
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu-email@gmail.com
SMTP_PASS=app_password_de_16_digitos
```

**SendGrid:**
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=tu_sendgrid_api_key
```

### Templates de Email

**Confirmaci√≥n de Reserva:**
- Header con colores de marca
- Detalles completos de la cita
- Recordatorios importantes
- Informaci√≥n de contacto

**Recordatorio 24h Antes:**
- Alert de cita pr√≥xima
- Fecha y hora destacadas
- Opci√≥n de reprogramar

**Funciones:**
```typescript
// Enviar confirmaci√≥n
await sendAppointmentConfirmation(appointment)

// Enviar recordatorio
await sendAppointmentReminder(appointment)

// Verificar configuraci√≥n
await testEmailConfiguration()
```

---

## üîÑ MANEJO DE FECHAS

### Funciones Centralizadas

Todas en `src/lib/date-utils.ts`:

```typescript
// Obtener hoy en formato YYYY-MM-DD
const today = getTodayString()

// Formatear para mostrar al usuario
const display = formatDateForDisplay('2025-10-20')
// Resultado: "lun, 20 oct 2025"

// Formatear Date para API
const apiDate = formatDateForAPI(new Date())
// Resultado: "2025-10-20"

// Parsear sin timezone issues
const date = parseLocalDate('2025-10-20')

// Obtener d√≠a de la semana (0-6)
const dayOfWeek = getDayOfWeek('2025-10-20')
```

**Importante:** Usar siempre estas funciones para evitar problemas de zona horaria.

---

## üóÑÔ∏è BASE DE DATOS

### Diagrama de Relaciones

```
specialists (1) ‚îÄ‚îÄ< (N) appointments (N) >‚îÄ‚îÄ (1) patients
                           ‚îÇ
                           ‚îî‚îÄ‚îÄ (1) aesthetic_services

specialists (1) ‚îÄ‚îÄ< (N) work_schedules
specialists (1) ‚îÄ‚îÄ< (N) closures
```

### Tablas Principales

#### `aesthetic_services`
Cat√°logo de servicios con categor√≠as y duraciones.

```sql
CREATE TABLE aesthetic_services (
  id UUID PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  duration INTEGER NOT NULL DEFAULT 45,
  category VARCHAR(20),
  is_active BOOLEAN DEFAULT true
);
```

#### `appointments`
Turnos agendados con constraint UNIQUE.

```sql
CREATE TABLE appointments (
  id UUID PRIMARY KEY,
  specialist_id UUID REFERENCES specialists(id),
  patient_id UUID REFERENCES patients(id),
  service_id UUID REFERENCES aesthetic_services(id),
  appointment_date DATE NOT NULL,
  appointment_time TIME NOT NULL,
  duration INTEGER NOT NULL,
  status VARCHAR(20) DEFAULT 'scheduled',
  notes TEXT,
  UNIQUE(specialist_id, appointment_date, appointment_time)
);
```

#### `work_schedules`
Horarios de trabajo con servicios permitidos.

```sql
CREATE TABLE work_schedules (
  id UUID PRIMARY KEY,
  specialist_id UUID,
  day_of_week INTEGER CHECK (day_of_week BETWEEN 0 AND 6),
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  lunch_start TIME,
  lunch_end TIME,
  allowed_services UUID[],
  UNIQUE(specialist_id, day_of_week)
);
```

#### `closures`
Cierres, vacaciones y feriados.

```sql
CREATE TABLE closures (
  id UUID PRIMARY KEY,
  specialist_id UUID,
  closure_type VARCHAR(20),
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  reason TEXT,
  is_active BOOLEAN DEFAULT true,
  CHECK (end_date >= start_date)
);
```

### Pol√≠ticas RLS

```sql
-- Servicios visibles p√∫blicamente
CREATE POLICY "Services viewable by everyone" 
  ON aesthetic_services FOR SELECT USING (true);

-- Solo admins pueden editar
CREATE POLICY "Services editable by admins only" 
  ON aesthetic_services FOR ALL 
  USING (auth.role() = 'service_role');
```

---

## üõ†Ô∏è TROUBLESHOOTING

### Error: Email no se env√≠a

**S√≠ntoma:** Reserva se crea pero no llega email.

**Soluciones:**
1. Verificar variables SMTP en Vercel
2. Para Gmail, generar App Password correctamente
3. Verificar logs: `console.log` en `src/lib/email.ts`
4. Probar configuraci√≥n: `await testEmailConfiguration()`

### Error: CAPTCHA fallido

**S√≠ntoma:** "Verificaci√≥n de seguridad fallida"

**Soluciones:**
1. Verificar que dominio est√© registrado en Google reCAPTCHA
2. Revisar que las keys sean correctas
3. En desarrollo, CAPTCHA se bypasea autom√°ticamente
4. Verificar en Network tab que se env√≠a `recaptchaToken`

### Error: Rate limit en desarrollo

**S√≠ntoma:** "Demasiadas solicitudes"

**Soluci√≥n:**
Rate limiting est√° deshabilitado en desarrollo autom√°ticamente:
```typescript
skip: (req) => process.env.NODE_ENV === 'development'
```

### Error: Overlap de horarios

**S√≠ntoma:** Horarios ocupados aparecen como disponibles.

**Verificar:**
1. Que la cita tenga campo `duration` correcto
2. Logs en `fetchAvailableTimes`
3. Query incluye `duration` en select

### Error: Fechas con un d√≠a de diferencia

**S√≠ntoma:** Fecha guardada es diferente a la mostrada.

**Soluci√≥n:**
Usar funciones de `date-utils.ts`:
```typescript
// ‚ùå NO hacer
const date = new Date(dateString).toISOString().split('T')[0]

// ‚úÖ Hacer
const date = formatDateForAPI(dateObject)
```

### Error: Build falla en Vercel

**S√≠ntomas comunes:**

1. **Missing environment variables**
   - Agregar todas las vars en Vercel Settings

2. **Module not found**
   - Verificar imports relativos
   - Ejecutar `npm install` localmente

3. **TypeScript errors**
   - Configurado para ignorar en build (temporal)
   - Corregir en desarrollo

---

## üìä ESQUEMA DE VALIDACIONES

### Reserva de Turno (Cliente)

```
1. Seleccionar servicio
   ‚Üì
2. Seleccionar fecha
   ‚îú‚îÄ Verificar si es pasada ‚ùå
   ‚îú‚îÄ Verificar si est√° cerrada ‚ùå
   ‚îî‚îÄ Continuar ‚úÖ
   ‚Üì
3. Seleccionar hora
   ‚îú‚îÄ Obtener horarios del especialista
   ‚îú‚îÄ Excluir horario de almuerzo
   ‚îú‚îÄ Obtener citas existentes con duraci√≥n
   ‚îú‚îÄ Calcular intervalos ocupados
   ‚îú‚îÄ Verificar overlap
   ‚îú‚îÄ Verificar servicios permitidos ese d√≠a
   ‚îî‚îÄ Mostrar solo horarios disponibles
   ‚Üì
4. Ingresar datos del paciente
   ‚îú‚îÄ Validar nombre (min 2 caracteres)
   ‚îú‚îÄ Validar email (regex estricta)
   ‚îî‚îÄ Validar tel√©fono (formato argentino)
   ‚Üì
5. Confirmar reserva
   ‚îú‚îÄ Obtener token reCAPTCHA
   ‚îú‚îÄ Enviar a API
   ‚îú‚îÄ Rate limiting (3/hora)
   ‚îú‚îÄ Verificar CAPTCHA (score > 0.5)
   ‚îú‚îÄ Verificar especialista activo
   ‚îú‚îÄ Verificar servicio activo
   ‚îú‚îÄ Verificar fecha no cerrada
   ‚îú‚îÄ Verificar horario disponible
   ‚îú‚îÄ Buscar/crear paciente
   ‚îú‚îÄ Crear cita (constraint UNIQUE)
   ‚îú‚îÄ Enviar email de confirmaci√≥n
   ‚îî‚îÄ Mostrar comprobante descargable
```

### Reserva desde Admin

```
Similar al flujo p√∫blico pero:
- Sin rate limiting (admin autenticado)
- Sin CAPTCHA (admin autenticado)
- Puede crear nuevo paciente inline
- Puede seleccionar cualquier horario
- Validaciones de overlap y cierres igualmente aplicadas
```

---

## üîß FUNCIONES CLAVE

### Validaci√≥n de Horarios Disponibles

**Archivo:** `src/lib/supabase-admin.ts`

```typescript
export async function getAvailableTimesForAdmin(
  specialistId: string, 
  date: string, 
  serviceId?: string
) {
  // 1. Obtener horario del d√≠a
  const schedule = await getWorkSchedule(specialistId, date)
  
  // 2. Verificar servicios permitidos
  if (serviceId && !isServiceAllowed(schedule, serviceId)) {
    return []
  }
  
  // 3. Obtener duraci√≥n del servicio
  const duration = await getServiceDuration(serviceId)
  
  // 4. Obtener citas existentes con duraci√≥n
  const existingAppointments = await getExistingAppointments(specialistId, date)
  
  // 5. Crear intervalos ocupados
  const occupiedIntervals = calculateOccupiedIntervals(
    existingAppointments,
    schedule.lunch_start,
    schedule.lunch_end
  )
  
  // 6. Generar horarios disponibles
  return generateAvailableSlots(
    schedule.start_time,
    schedule.end_time,
    duration,
    occupiedIntervals
  )
}
```

### Env√≠o de Emails

**Archivo:** `src/lib/email.ts`

```typescript
// Confirmaci√≥n inmediata
export async function sendAppointmentConfirmation(appointment) {
  const mailOptions = {
    from: '"Est√©tica Integral" <noreply@esteticaintegral.com.ar>',
    to: appointment.patient.email,
    subject: '‚úÖ Confirmaci√≥n de Turno',
    html: createConfirmationTemplate(appointment)
  }
  
  await transporter.sendMail(mailOptions)
}

// Recordatorio 24h antes
export async function sendAppointmentReminder(appointment) {
  // Similar pero con template de recordatorio
}
```

---

## üì± PWA - PROGRESSIVE WEB APP

### Configuraci√≥n

**next.config.js:**
```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === 'development'
})

module.exports = withPWA(nextConfig)
```

**public/manifest.json:**
```json
{
  "name": "Est√©tica Integral",
  "short_name": "Est√©tica",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#a6566c"
}
```

### Instalaci√≥n

**iOS (Safari):**
1. Abrir sitio en Safari
2. Tap en icono de compartir
3. "Agregar a pantalla de inicio"

**Android (Chrome):**
1. Abrir sitio en Chrome
2. Men√∫ > "Instalar app"
3. Confirmar

**Desktop (Chrome):**
1. Icono de instalaci√≥n en barra de direcci√≥n
2. Click "Instalar"

---

## üîê CREDENCIALES POR DEFECTO

### Admin User
- **Email:** admin@esteticaintegral.com.ar
- **Password:** admin123
- **‚ö†Ô∏è CAMBIAR EN PRODUCCI√ìN**

### Cambiar Password Admin

```sql
-- Generar hash con bcrypt
-- Usar scripts/generate-password-hash.js

UPDATE admin_users 
SET password_hash = '$2b$10$nuevo_hash_aqui'
WHERE email = 'admin@esteticaintegral.com.ar';
```

---

## üìä M√âTRICAS Y ANALYTICS

### Dashboard Stats

**M√©tricas disponibles:**
- Total de citas
- Citas hoy
- Citas programadas
- Citas completadas
- Citas canceladas
- Esta semana
- Este mes
- Promedio por d√≠a
- Tasa de ocupaci√≥n (%)
- Top 5 servicios m√°s solicitados

### C√°lculo de Ocupaci√≥n

```typescript
// Asume 8 horas/d√≠a, slots seg√∫n duraci√≥n de servicios
const daysInMonth = 30
const availableSlots = daysInMonth * 8
const occupancyRate = (appointmentsThisMonth / availableSlots) * 100
```

---

## üß© INTEGRACIONES

### Supabase

**Configuraci√≥n:**
- Project URL
- Anon key (cliente p√∫blico)
- Service role key (operaciones admin)

**Clientes:**
```typescript
// Cliente p√∫blico (frontend)
import { supabase } from '@/lib/supabase'

// Cliente admin (backend only)
import { supabaseAdmin } from '@/lib/supabase-admin'
```

### Google reCAPTCHA

**Configuraci√≥n:**
1. Crear sitio en https://www.google.com/recaptcha/admin
2. Tipo: reCAPTCHA v3
3. Dominios: localhost + tu-dominio.vercel.app
4. Copiar Site Key ‚Üí frontend
5. Copiar Secret Key ‚Üí backend

### Vercel Cron

**Archivo:** `vercel.json`
```json
{
  "crons": [{
    "path": "/api/cron/send-reminders",
    "schedule": "0 10 * * *"
  }]
}
```

**Formato schedule:** Cron expression (minuto hora d√≠a mes d√≠aSemana)
- `0 10 * * *` = Todos los d√≠as a las 10:00 AM
- `0 */2 * * *` = Cada 2 horas
- `0 9 * * 1` = Lunes a las 9 AM

---

## üéØ FLUJO DE DATOS

### Creaci√≥n de Reserva P√∫blica

```
Usuario ‚Üí Frontend (AppointmentBooking)
    ‚îú‚îÄ Validar datos localmente
    ‚îú‚îÄ Obtener token reCAPTCHA
    ‚îî‚îÄ POST /api/appointments
        ‚îú‚îÄ Rate limiting (3/hora)
        ‚îú‚îÄ Verificar reCAPTCHA
        ‚îî‚îÄ supabase-admin.createPublicAppointment()
            ‚îú‚îÄ Verificar especialista activo
            ‚îú‚îÄ Verificar servicio activo
            ‚îú‚îÄ Verificar fecha no cerrada
            ‚îú‚îÄ Verificar horario disponible
            ‚îú‚îÄ Buscar/crear paciente
            ‚îú‚îÄ INSERT appointment (constraint UNIQUE)
            ‚îú‚îÄ Enviar email confirmaci√≥n
            ‚îî‚îÄ Retornar cita creada
```

### Reserva desde Admin

```
Admin ‚Üí AdminDashboard
    ‚îú‚îÄ Verificar autenticaci√≥n (middleware)
    ‚îî‚îÄ POST /api/admin/appointments
        ‚îî‚îÄ supabase-admin.createAppointmentForAdmin()
            ‚îú‚îÄ Verificar fecha no cerrada
            ‚îú‚îÄ Verificar horario disponible
            ‚îú‚îÄ INSERT appointment
            ‚îî‚îÄ Retornar cita creada
```

---

## üìù NOTAS T√âCNICAS

### TypeScript

**Tipos principales:**
```typescript
interface AppointmentData {
  id: string
  appointment_date: string  // YYYY-MM-DD
  appointment_time: string  // HH:mm
  duration: number          // minutos
  status: 'scheduled' | 'completed' | 'cancelled'
  specialist: Specialist
  service: AestheticService
  patient: Patient
}
```

### Logging

**Uso del logger:**
```typescript
import { logger } from '@/lib/logger'

logger.log('Mensaje de debug')      // Solo en dev
logger.warn('Advertencia')           // Solo en dev
logger.error('Error')                // Siempre
```

---

## üö¶ CHECKLIST DE PRODUCCI√ìN

### Antes de Deploy

- [ ] Variables de entorno configuradas en Vercel
- [ ] reCAPTCHA configurado con dominio correcto
- [ ] SMTP configurado si quieres emails
- [ ] Password de admin cambiado
- [ ] JWT_SECRET generado seguro (32+ chars)
- [ ] CRON_SECRET generado si usas recordatorios

### Despu√©s de Deploy

- [ ] Probar reserva p√∫blica funciona
- [ ] Probar login admin funciona
- [ ] Verificar que lleguen emails
- [ ] Probar rate limiting (3 reservas seguidas)
- [ ] Instalar PWA en m√≥vil
- [ ] Verificar vista de calendario

---

## üìû SOPORTE

**Repositorio:** https://github.com/cocomeza/estetica.integral  
**Issues:** https://github.com/cocomeza/estetica.integral/issues  
**Demo:** https://estetica-integral.vercel.app

---

**√öltima actualizaci√≥n:** 20 de Octubre, 2025  
**Versi√≥n:** 2.0.0  
**Estado:** ‚úÖ Producci√≥n

